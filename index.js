const livers = {
  "UCbLgcjfsUaCUgJh9SVit8kw": ["staff"],
  // 3SetBBQ
  "UCA3WE2WRSpoIvtnoVGq4VAw": ["zea", "mothercorn", "lia"],
  "UCZ5dNZsqBjBzbBl0l_IdmXg": ["taka", "tamka", "tk"],
  "UCpJtk0myFr5WnyfsmnInP-w": ["hana", "hamna", "hanamaki", "hanmak"],
  // Clover McOver
  "UCOmjciHZ8Au3iKMElKXCF_g": ["miyu", "lider"],
  "UCkL9OLKjIQbKk2CztbpOCFg": ["riksa", "jukut"],
  "UC8Snw5i4eOJXEQqURAK17hQ": ["rai"],
  "UCrR7JxkbeLY82e8gsj_I0pQ": ["cia", "amicia", "amicin", "amichon"],
  // LAN_NEE3S
  "UCoWH3sDpeXG1aXmOxveX4KA": ["nara", "maung", "mamaung"],
  "UCyRkQSuhJILuGOuXk10voPg": ["layla", "lele"],
  "UCk5r533QVMgJUdWwqegH2TA": ["azura", "zura", "jura", "azuwin"],
  // 3FicLite
  "UCjFu-9GHnabzSFRAYm1B9Dw": ["etna"],
  "UCHjeZylSgXDSnor8wUnwU_g": ["bobon", "bonni", "bonnivier"],
  "UC5qSx7KzdRwbsO1QmJc4d-w": ["siska", "siskuy"],
  // 53Renade
  "UCijNnZ-6m8g85UGaRAWuw7g": ["nagisa"],
  "UCMzVa7B8UEdrvUGsPmSgyjA": ["derem"],
  "UC5yckZliCkuaEFbqzLBD7hQ": ["reza", "ejak"],
  // Wave 6
  "UCIBj1-d71vKjRftiauF50pg": ["hyona"],
  "UCoJ0Ct-jdas4cLPpSp06gZg": ["xia","xixixia"],
  "UCahgMxSIQ2zIRrPKhM6Mjvg": ["mika"],
  // Niji
  "UC8C1LLhBhf_E2IBPLSDJXlQ": ["sukoya"],
  "UCspv01oxUFf_MTSipURRhkA": ["kanae"],


  // NijiKR
  "UCLjx3lqIkYkPCBJop8czJ2A": ["hada"],
  "UCeGendL8CO5RkffB6IFwHow": ["seffyna"],
  "UCClwIqTUn5LDpFucHyaAhHg": ["roha"],
  "UC1ZV7KBscK0EMoJKFu1DnDg": ["bora"],
  "UCmWqYB6y8gSfPONWGspuOWQ": ["ara"],
  "UC5ek2GWKvUKFgnKSHuuCFrw": ["nagi"],
  "UCSlv7Z-4q7_7NRkzJB10A5Q": ["siu"],
  "UCUtKkGKef8BYMs3h-3zQm9A": ["suha"],

  // NijiEN
  "UC-JSeFfovhNsEhftt1WHMvg": ["english"],
  "UCu-J8uIXuLZh16gG-cT1naw": ["finana", "finance"],
  "UCIeSUTOTkF9Hs7q3SGcO-Ow": ["elira"],
  "UCP4nMSTdwU1KqYWu3UH5DHQ": ["pomu"],
  "UCV1xUwfM2v2oBtT3JNvic3w": ["selen"],
  "UC4WvIIAo89_AzGUh1AZ6Dkg": ["rosemi"],
  "UCgA2jKRkqpY_8eysPUs8sjw": ["petra"],
  "UCR6qhsLpn62WVxCBK1dkLow": ["enna"],
  "UC47rNmkDcNgbOcM-2BwzJTQ": ["millie"],
  "UCBURM8S4LH7cRZ0Clea9RDA": ["reimu"],
  "UCkieJGn3pgJikVW8gmMXE2w": ["nina"],
  "UCckdfYDGrjojJM28n5SHYrA": ["vox"],
  "UCG0rzBZV_QMP4MtWg6IjhEA": ["shu"],
  "UC4yNIKGvy-YUrwYupVdLDXA": ["ike"],
  "UC7Gb7Uawe20QyFibhLl1lzA": ["luca"],
  "UCIM92Ok_spNKLVB5TsgwseQ": ["mysta"],
  "UCGhqxhovNfaPBpxfCruy9EA": ["fulgur"],
  "UChJ5FTsHOu72_5OVx0rvsvQ": ["uki"],
  "UCQ1zGxHrfEmmW4CPpBx9-qw": ["alban"],
  "UCuuAb_72QzK0M1USPMEl1yw": ["sonny"],
  "UCSc_KzY_9WYAx9LghggjVRA": ["yugo"],
  "UCwaS8_S7kMiKA3izlTWHbQg":["maria"],
  "UCsb-1aJgiJXJH2feV-zlZRw":["kyo"],
  "UCN68LoM3khS4gdBMiWJO8WA":["aia"],
  "UCpzxZW5kghGnO5TmAFJQAVw":["aster"],
  "UCFgXWZOUZA2oYHNr6qDmsTQ":["scarle"],
  "UCKu59gTZ_rdEmerdx5rV4Yg":["ren"],

  // HoloEN
  "UCL_qhgtOy0dy1Agp8vkySQg": ["calli"],
  "UCHsx4Hqa-1ORjQTh9TYDhww": ["kiara"],
  "UCMwGHR0BTZuLsmjY_NT5Pwg": ["ina"],
  "UCoSrY_IQQVpmIRZ9Xf-y93g": ["gura"],
  "UCyl1z3jo3XHR1riLFKG5UAg": ["watson"],
  "UC8rcEBzJSleTkf_-agPM20g": ["irys"],

  // Tempus
  "UCyxtGMdWlURZ30WSnEjDOQw":["regis"],
  "UC7MMNHR-kf9EN1rXiesMTMw":["magni"],
  "UC2hx0xVkMoHGWijwr_lA01w":["axel"],
  "UCDRWSO281bIHYVi-OV3iFYA":["noir"],

  // HoloID
  "UCOyYb1c43VlX9rc_lT6NKQw": ["risu"],
  "UCP0BspO_AMEe3aQqqpo89Dg": ["moona"],
  "UCAoy6rzhSf4ydcYjJw3WoVg": ["iofi"],
  "UCYz_5n-uDuChHtLo7My1HnQ": ["ollie"],
  "UC727SQYUvx5pDDGQpTICNWg": ["anya"],
  "UChgTyjG-pdNvxxhdsXfHQ5Q": ["reine"],
  "UCTvHWSfBZgtxE4sILOaurIQ": ["zeta"],
  "UCZLZ8Jjx_RN2CXloOmgTHVg": ["kaela"],
  "UCjLEmnpCNeisMxy134KPwWw": ["kobo"],
}

const liverMap = {}

const errorPage =
  "https://gist.github.com/ohareza/502eff996358202095fafcd529328326#file-niji-live-md"

function dns() {
    dnsStr = ""

    Object.keys(liverMap).forEach((alias) => {
        dnsStr += alias + "\t1\tIN\tA\t2.4.3.4\n";
    })

    return new Response(dnsStr, { 
        headers: { 
            "content-type": "text/plain;charset=UTF-8"
        } 
    })
}

async function handleRequest(request) {

  if (Object.keys(liverMap).length === 0) {
    // Lazily initialize livermap
    for (const [id, nicks] of Object.entries(livers)) {
      nicks.forEach((nick) => {
        liverMap[nick] = id
      })
    }
  }

  const url = new URL(request.url)

  if(url.pathname.substring(1) == "dns") {
      return dns()
  }

  const ident = (
    url.hostname.split(".").slice(0, -2).join(".") || url.pathname.substring(1)
  ).toLowerCase()

  if (!/[^a-zA-Z]/.test(ident)) {
    if (ident in liverMap) {
      return Response.redirect(
        "https://www.youtube.com/channel/" + liverMap[ident] + "/live",
        301
      )
    } else {
      return Response.redirect(errorPage, 302)
    }
  }

  const channelIds = []

  ident.split(/[^a-zA-Z0-9]/).forEach((nick) => {
    if (nick in liverMap) {
      channelIds.push(liverMap[nick])
    }
  })

  const queryFetch = await fetch("https://api.ihateani.me/v2/graphql", {
    body: JSON.stringify({
      query: `query VTuberLives($ids: [ID]) {vtuber {
        live(channel_id: $ids) {items {id, channel_id}},
        upcoming(channel_id: $ids) {items {id, channel_id, timeData{scheduledStartTime}}}
      }}`,
      variables: {
        ids: channelIds,
      },
    }),
    headers: {
      "accept": "application/json",
      "content-type": "application/json",
    },
    method: "POST",
    cf: {
      cacheEverything: true,
      cacheTtl: 60,
    },
  })

  const queryJSON = await queryFetch.json()

  const queryRes = queryJSON.data.vtuber

  const videoIds = []

  channelIds.forEach((id) => {
    // Put currently ongoing stream to videoIds
    // If it doesn't exist, put soonest scheduled stream
    let found = false
    queryRes.live.items.forEach((live) => {
      if (live.channel_id == id) {
        found = true
        videoIds.push(live.id)
        return
      }
    })
    if (found) {
      return
    }
    let minTime = Infinity
    let minId = ""
    queryRes.upcoming.items.forEach((live) => {
      if (live.channel_id == id && live.timeData.scheduledStartTime < minTime) {
        minTime = live.timeData.scheduledStartTime
        minId = live.id
      }
    })
    if (minId) {
      videoIds.push(minId)
    }
  })

  if (videoIds.length > 0) {
    let theaterUrl = "https://twitchtheater.tv"
    videoIds.forEach((id) => {
      theaterUrl += "/v=" + id
    })

    return Response.redirect(theaterUrl, 302)
  }

  return Response.redirect(errorPage, 302)
}

addEventListener("fetch", async (event) => {
  return event.respondWith(handleRequest(event.request))
})
